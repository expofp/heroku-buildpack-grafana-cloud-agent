#!/bin/sh

BUILD_DIR="${1:-}"
CACHE_DIR="${2:-}"
ENV_DIR="${3:-}"

[ -z "$BUILD_DIR" ] && BUILD_DIR=`pwd`
[ -z "$CACHE_DIR" ] && CACHE_DIR="/tmp"
[ -z "$ENV_DIR" ] && ENV_DIR="dev"

VER=$(heroku config:get GRAFANA_AGENT_VERSION)
[ -z "$VER" ] && VER="0.31.0-rc.0"

die(){
  echo "$@"
  exit 1
}

# See https://github.com/grafana/agent/releases/

echo "Downloading Grafana agent binary $VER ..."
[ -d "$BUILD_DIR/bin" ] || mkdir -p "$BUILD_DIR/bin"

[ -f grafana-agent-linux-amd64.zip ] || curl -O -L  "https://github.com/grafana/agent/releases/download/v$VER/grafana-agent-linux-amd64.zip" || die
[ -f grafana-agent-linux-amd64 ] || unzip grafana-agent-linux-amd64.zip 
mv grafana-agent-linux-amd64 "$BUILD_DIR/bin/grafana-agent"
rm grafana-agent-linux-amd64.zip || die

echo "Grafana agent binary installed."

# Debugging
echo "Config"
cat "$BUILD_DIR/config/grafana-agent.yml"
