#!/bin/sh

BUILD_DIR="${1:-}"
CACHE_DIR="${2:-}"
ENV_DIR="${3:-}"

VER="v0.31.0-rc.0"

[ -z "$BUILD_DIR" ] && BUILD_DIR=`pwd`
[ -z "$CACHE_DIR" ] && CACHE_DIR="cache"
[ -z "$ENV_DIR" ] && ENV_DIR="dev"

die(){
  echo "$@"
  exit 1
}

# https://github.com/grafana/agent/releases/

echo "Downloading Grafana agent binary $VER ..."
[ -d "$BUILD_DIR/bin" ] || mkdir -p "$BUILD_DIR/bin"

[ -f grafana-agent-linux-amd64.zip ] || curl -O -L  "https://github.com/grafana/agent/releases/download/$VER/grafana-agent-linux-amd64.zip" || die
[ -f grafana-agent-linux-amd64 ] || unzip grafana-agent-linux-amd64.zip 
mv grafana-agent-linux-amd64 "$BUILD_DIR/bin/grafana-agent"
rm grafana-agent-linux-amd64.zip || die

echo "Grafana agent binary installed."

echo "Copying configuration file"
cp "config/grafana-agent.yml" "$BUILD_DIR/grafana-agent.yml" || die

# Debugging
echo "Config"
cat "$BUILD_DIR/grafana-agent.yml"

echo 9090 > "$BUILD_DIR/PORT.ENV"
echo "PORT: $(cat $BUILD_DIR/PORT.ENV)"
uname -a

